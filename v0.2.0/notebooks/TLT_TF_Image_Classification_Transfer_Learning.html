<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transfer Learning for Image Classification using TensorFlow and the Intel® Transfer Learning Tool API &mdash; Intel® Transfer Learning Tool 0.2.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Text Classification fine tuning using TensorFlow and the Intel® Transfer Learning Tool API" href="TLT_TF_Text_Classification_Transfer_Learning.html" />
    <link rel="prev" title="Transfer Learning for Image Classification using PyTorch and the Intel® Transfer Learning Tool API" href="TLT_PyTorch_Image_Classification_Transfer_Learning.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Intel® Transfer Learning Tool
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Intel® Transfer Learning Tool Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli.html">CLI Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../notebooks.html">Example Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="TLT_PyTorch_Image_Classification_Transfer_Learning.html">Transfer Learning for Image Classification using PyTorch and the Intel® Transfer Learning Tool API</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Transfer Learning for Image Classification using TensorFlow and the Intel® Transfer Learning Tool API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#1.-Import-dependencies-and-setup-parameters">1. Import dependencies and setup parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Get-the-model">2. Get the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Get-the-dataset">3. Get the dataset</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Option-A:-Use-your-own-dataset">Option A: Use your own dataset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Option-B:-Use-a-dataset-from-the-TensorFlow-Datasets-catalog">Option B: Use a dataset from the TensorFlow Datasets catalog</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#4.-Prepare-the-dataset">4. Prepare the dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#5.-Predict-using-the-original-model">5. Predict using the original model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#6.-Transfer-Learning">6. Transfer Learning</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Arguments">Arguments</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#7.-Predict">7. Predict</a></li>
<li class="toctree-l3"><a class="reference internal" href="#8.-Export">8. Export</a></li>
<li class="toctree-l3"><a class="reference internal" href="#9.-Post-training-quantization">9. Post-training quantization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Dataset-Citations">Dataset Citations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="TLT_TF_Text_Classification_Transfer_Learning.html">Text Classification fine tuning using TensorFlow and the Intel® Transfer Learning Tool API</a></li>
<li class="toctree-l2"><a class="reference internal" href="Medical_Imaging_Classification.html">Medical Imaging Classification (Colorectal histology) using TensorFlow and the Intel® Transfer Learning Tool API</a></li>
<li class="toctree-l2"><a class="reference internal" href="Remote_Sensing_Image_Scene_Classification.html">Remote Sensing Image Scene Classification (Resisc) using TensorFlow and the Intel® Transfer Learning Tool API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../notebooks.html#environment-setup-and-running-the-notebooks">Environment Setup and Running the Notebooks</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Intel® Transfer Learning Tool</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../notebooks.html">Example Notebooks</a></li>
      <li class="breadcrumb-item active">Transfer Learning for Image Classification using TensorFlow and the Intel® Transfer Learning Tool API</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/TLT_TF_Image_Classification_Transfer_Learning.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Transfer-Learning-for-Image-Classification-using-TensorFlow-and-the-Intel®-Transfer-Learning-Tool-API">
<h1>Transfer Learning for Image Classification using TensorFlow and the Intel® Transfer Learning Tool API<a class="headerlink" href="#Transfer-Learning-for-Image-Classification-using-TensorFlow-and-the-Intel®-Transfer-Learning-Tool-API" title="Permalink to this heading">¶</a></h1>
<p>This notebook uses the <code class="docutils literal notranslate"><span class="pre">tlt</span></code> library to do transfer learning for image classfication with a TensorFlow pretrained model.</p>
<section id="1.-Import-dependencies-and-setup-parameters">
<h2>1. Import dependencies and setup parameters<a class="headerlink" href="#1.-Import-dependencies-and-setup-parameters" title="Permalink to this heading">¶</a></h2>
<p>This notebook assumes that you have already followed the instructions to setup a TensorFlow environment with all the dependencies required to run the notebook.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import matplotlib.pyplot as plt
import numpy as np
import os
import pandas as pd
import PIL.Image as Image
import tensorflow as tf

# tlt imports
from tlt.datasets import dataset_factory
from tlt.models import model_factory
from tlt.utils.file_utils import download_file, download_and_extract_tar_file

# Specify a directory for the dataset to be downloaded
dataset_dir = os.environ[&quot;DATASET_DIR&quot;] if &quot;DATASET_DIR&quot; in os.environ else \
    os.path.join(os.environ[&quot;HOME&quot;], &quot;dataset&quot;)

# Specify a directory for output
output_dir = os.environ[&quot;OUTPUT_DIR&quot;] if &quot;OUTPUT_DIR&quot; in os.environ else \
    os.path.join(os.environ[&quot;HOME&quot;], &quot;output&quot;)

print(&quot;Dataset directory:&quot;, dataset_dir)
print(&quot;Output directory:&quot;, output_dir)
</pre></div>
</div>
</div>
</section>
<section id="2.-Get-the-model">
<h2>2. Get the model<a class="headerlink" href="#2.-Get-the-model" title="Permalink to this heading">¶</a></h2>
<p>In this step, we call the TLT model factory to list supported TensorFlow image classification models. This is a list of pretrained models from <a class="reference external" href="https://tfhub.dev">TFHub</a> that we tested with our API. Optionally, the <code class="docutils literal notranslate"><span class="pre">verbose=True</span></code> argument can be added to the <code class="docutils literal notranslate"><span class="pre">print_supported_models</span></code> function call to get more information about each model (such as the link to TFHub, image size, the original dataset, etc).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># See a list of available models
model_factory.print_supported_models(use_case=&#39;image_classification&#39;, framework=&#39;tensorflow&#39;)
</pre></div>
</div>
</div>
<p>Next, use the model factory to get one of the models listed in the previous cell. The <code class="docutils literal notranslate"><span class="pre">get_model</span></code> function returns a model object that will later be used for training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model = model_factory.get_model(model_name=&#39;resnet_v1_50&#39;, framework=&#39;tensorflow&#39;)

print(&quot;Model name:&quot;, model.model_name)
print(&quot;Framework:&quot;, model.framework)
print(&quot;Use case:&quot;, model.use_case)
print(&quot;Image size:&quot;, model.image_size)
</pre></div>
</div>
</div>
</section>
<section id="3.-Get-the-dataset">
<h2>3. Get the dataset<a class="headerlink" href="#3.-Get-the-dataset" title="Permalink to this heading">¶</a></h2>
<p>We call the dataset factory to get a sample image classification dataset. For demonstration purposes, we are using the <a class="reference external" href="https://www.tensorflow.org/datasets/catalog/tf_flowers">tf_flowers</a> dataset from the <a class="reference external" href="https://www.tensorflow.org/datasets">TensorFlow Datasets catalog</a>. This dataset contains images of flowers in 5 different classes.</p>
<section id="Option-A:-Use-your-own-dataset">
<h3>Option A: Use your own dataset<a class="headerlink" href="#Option-A:-Use-your-own-dataset" title="Permalink to this heading">¶</a></h3>
<p>To use your own image dataset for transfer learning with the rest of this notebook, format your images as <code class="docutils literal notranslate"><span class="pre">.jpg</span></code> files and save them in folders named after the classes that you want the model to predict. To provide a working example using the correct layout, we will download a flower species dataset. After downloading and extracting, you will have the following subdirectories in your dataset directory. Each species subfolder will contain numerous <code class="docutils literal notranslate"><span class="pre">.jpg</span></code> files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>flower_photos
  └── daisy
  └── dandelion
  └── roses
  └── sunflowers
  └── tulips
</pre></div>
</div>
<p>When using your own dataset, ensure that it is similarly organized with folders for each class. Change the <code class="docutils literal notranslate"><span class="pre">custom_dataset_path</span></code> variable to point to your dataset folder.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># For demonstration purposes, we download a flowers dataset. To instead use your own dataset, set the
# custom_dataset_path to point to your dataset&#39;s directory and comment out the download_and_extract_tar_file line.
custom_dataset_path = os.path.join(dataset_dir, &quot;flower_photos&quot;)

if not os.path.exists(custom_dataset_path):
    download_url = &quot;https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz&quot;
    download_and_extract_tar_file(download_url, dataset_dir)
</pre></div>
</div>
</div>
<p>Call the dataset factory to load the dataset from the directory.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Load the dataset from the custom dataset path
dataset = dataset_factory.load_dataset(dataset_dir=custom_dataset_path,
                                       use_case=&#39;image_classification&#39;,
                                       framework=&#39;tensorflow&#39;)

print(&quot;Class names:&quot;, str(dataset.class_names))
</pre></div>
</div>
</div>
<p>Skip to the next step <a class="reference external" href="#4.-Prepare-the-dataset">4. Prepare the dataset</a> to continue using the custom dataset.</p>
</section>
<section id="Option-B:-Use-a-dataset-from-the-TensorFlow-Datasets-catalog">
<h3>Option B: Use a dataset from the TensorFlow Datasets catalog<a class="headerlink" href="#Option-B:-Use-a-dataset-from-the-TensorFlow-Datasets-catalog" title="Permalink to this heading">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataset = dataset_factory.get_dataset(dataset_dir=dataset_dir,
                                      use_case=&#39;image_classification&#39;,
                                      framework=&#39;tensorflow&#39;,
                                      dataset_name=&#39;tf_flowers&#39;,
                                      dataset_catalog=&#39;tf_datasets&#39;)

print(dataset.info)

print(&quot;\nClass names:&quot;, str(dataset.class_names))
</pre></div>
</div>
</div>
</section>
</section>
<section id="4.-Prepare-the-dataset">
<h2>4. Prepare the dataset<a class="headerlink" href="#4.-Prepare-the-dataset" title="Permalink to this heading">¶</a></h2>
<p>Once you have your dataset from Option A or Option B above, use the following cells to split and preprocess the data. We split them into training and validation subsets, then resize the images to match the selected models, and then batch the images. Data augmentation can be applied by specifying the augmentations to be applied in <strong>add_aug</strong> parameter. Supported augmentations are: 1. hvflip - RandomHorizontalandVerticalFlip 2. hflip - RandomHorizontalFlip 3. vflip - RandomVerticalFlip 4. rotate
- RandomRotate 5. zoom - RandomZoom</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Split the dataset into training and validation subsets
dataset.shuffle_split(train_pct=.75, val_pct=.25)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Preprocess the dataset with an image size that matches the model and a batch size of 32
batch_size = 32
dataset.preprocess(model.image_size, batch_size=batch_size, add_aug=[&#39;hvflip&#39;, &#39;rotate&#39;, &#39;zoom&#39;])
</pre></div>
</div>
</div>
</section>
<section id="5.-Predict-using-the-original-model">
<h2>5. Predict using the original model<a class="headerlink" href="#5.-Predict-using-the-original-model" title="Permalink to this heading">¶</a></h2>
<p>We get a single batch from our dataset, and use that to call predict on our model. Since we haven’t done any training on the model yet, it will give us predictions using the original ImageNet trained model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Get a single batch from the dataset
images, labels = dataset.get_batch()
labels = [dataset.class_names[id] for id in labels]

# Download the ImageNet labels and load them into a list
labels_file = &quot;https://storage.googleapis.com/download.tensorflow.org/data/ImageNetLabels.txt&quot;
downloaded_file = tf.keras.utils.get_file(&quot;labels.txt&quot;, origin=labels_file)
imagenet_classes = []

with open(downloaded_file) as f:
    imagenet_labels = f.readlines()
    imagenet_classes = [l.strip() for l in imagenet_labels]

# Predict using the original model
predictions = model.predict(images)
predictions = [imagenet_classes[id] for id in predictions]
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Display the images with the predicted ImageNet label
plt.figure(figsize=(18,14))
plt.subplots_adjust(hspace=0.5)
for n in range(min(batch_size, 30)):
    plt.subplot(6,5,n+1)
    plt.imshow(images[n])
    correct_prediction = labels[n] == predictions[n]
    color = &quot;darkgreen&quot; if correct_prediction else &quot;crimson&quot;
    title = predictions[n].title() if correct_prediction else &quot;{}\n({})&quot;.format(predictions[n], labels[n])
    plt.title(title, fontsize=14, color=color)
    plt.axis(&#39;off&#39;)
_ = plt.suptitle(&quot;ImageNet predictions&quot;, fontsize=20)
plt.show()

print(&quot;Correct predictions are shown in green&quot;)
print(&quot;Incorrect predictions are shown in red with the actual label in parenthesis&quot;)
</pre></div>
</div>
</div>
</section>
<section id="6.-Transfer-Learning">
<h2>6. Transfer Learning<a class="headerlink" href="#6.-Transfer-Learning" title="Permalink to this heading">¶</a></h2>
<p>This step calls the model’s train function with the dataset that was just prepared. The training function will get the TFHub feature vector and add on a dense layer based on the number of classes in the dataset. The model is then compiled and trained based on the number of epochs specified in the argument. With the do_eval paramter set to True by default, this step will also show how the model can be evaluated and will return a list of metrics calculated from the dataset’s validation subset.</p>
<section id="Arguments">
<h3>Arguments<a class="headerlink" href="#Arguments" title="Permalink to this heading">¶</a></h3>
<section id="Required">
<h4>Required<a class="headerlink" href="#Required" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p><strong>dataset</strong> (ImageClassificationDataset, required): Dataset to use when training the model</p></li>
<li><p><strong>output_dir</strong> (str): Path to a writeable directory for checkpoint files</p></li>
<li><p><strong>epochs</strong> (int): Number of epochs to train the model (default: 1)</p></li>
</ul>
</section>
<section id="Optional">
<h4>Optional<a class="headerlink" href="#Optional" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p><strong>initial_checkpoints</strong> (str): Path to checkpoint weights to load. If the path provided is a directory, the latest checkpoint will be used.</p></li>
<li><p><strong>early_stopping</strong> (bool): Enable early stopping if convergence is reached while training at the end of each epoch. (default: False)</p></li>
<li><p><strong>lr_decay</strong> (bool): If lr_decay is True and do_eval is True, learning rate decay on the validation loss is applied at the end of each epoch.</p></li>
<li><p><strong>enable_auto_mixed_precision</strong> (bool or None): Enable auto mixed precision for training. Mixed precision uses both 16-bit and 32-bit floating point types to make training run faster and use less memory. It is recommended to enable auto mixed precision training when running on platforms that support bfloat16 (Intel third or fourth generation Xeon processors). If it is enabled on a platform that does not support bfloat16, it can be detrimental to the training performance. If
enable_auto_mixed_precision is set to None, auto mixed precision will be automatically enabled when running with Intel fourth generation Xeon processors, and disabled for other platforms.</p></li>
<li><p><strong>extra_layers</strong> (list[int]): Optionally insert additional dense layers between the base model and output layer. This can help increase accuracy when fine-tuning a TFHub model. The input should be a list of integers representing the number and size of the layers, for example [1024, 512] will insert two dense layers, the first with 1024 neurons and the second with 512 neurons.</p></li>
</ul>
<p>Note: refer to release documentation for an up-to-date list of train arguments and their current descriptions</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>enable_auto_mixed_precision = None

# Train using the pretrained model from TF Hub with the new dataset
history = model.train(dataset, output_dir=output_dir, epochs=1,
                      enable_auto_mixed_precision=enable_auto_mixed_precision)
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="7.-Predict">
<h2>7. Predict<a class="headerlink" href="#7.-Predict" title="Permalink to this heading">¶</a></h2>
<p>Let’s predict using the same single batch that we used earlier with the ImageNet trained model to visualize the model’s predictions after training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Predict with a single batch
predictions = model.predict(images)

# Map the predicted ids to the class names
predictions = [dataset.class_names[id] for id in predictions]

# Display the results
plt.figure(figsize=(16,16))
plt.subplots_adjust(hspace=0.5)
for n in range(min(batch_size, 30)):
    plt.subplot(6,5,n+1)
    plt.imshow(images[n])
    correct_prediction = labels[n] == predictions[n]
    color = &quot;darkgreen&quot; if correct_prediction else &quot;crimson&quot;
    title = predictions[n].title() if correct_prediction else &quot;{}\n({})&quot;.format(predictions[n], labels[n])
    plt.title(title, fontsize=14, color=color)
    plt.axis(&#39;off&#39;)
_ = plt.suptitle(&quot;Model predictions&quot;, fontsize=16)
plt.show()
print(&quot;Correct predictions are shown in green&quot;)
print(&quot;Incorrect predictions are shown in red with the actual label in parenthesis&quot;)
</pre></div>
</div>
</div>
<p>We can also predict using a single image that wasn’t part of our original dataset. We download a flower image from the <a class="reference external" href="https://storage.googleapis.com/openimages/web/index.html">Open Images Dataset</a> and then resize it to match our model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Download an image from the web and resize it to match our model
image_url = &quot;https://c8.staticflickr.com/8/7095/7210797228_c7fe51c3cb_z.jpg&quot;
daisy = download_file(image_url, output_dir)

image_shape = (model.image_size, model.image_size)
daisy = Image.open(daisy).resize(image_shape)
daisy
</pre></div>
</div>
</div>
<p>Then, we call predict by passing the np array for our image and add a dimension to our array to represent the batch.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Get the image as a np array and call predict while adding a batch dimension (with np.newaxis)
daisy = np.array(daisy)/255.0
result = model.predict(daisy[np.newaxis, ...])

# Print the predicted class name
print(dataset.class_names[result[0]])
</pre></div>
</div>
</div>
</section>
<section id="8.-Export">
<h2>8. Export<a class="headerlink" href="#8.-Export" title="Permalink to this heading">¶</a></h2>
<p>Next, we can call the model <code class="docutils literal notranslate"><span class="pre">export</span></code> function to generate a <code class="docutils literal notranslate"><span class="pre">saved_model.pb</span></code>. The model is saved in a format that is ready to use with <a class="reference external" href="https://github.com/tensorflow/serving">TensorFlow Serving</a>. Each time the model is exported, a new numbered directory is created, which allows serving to pick up the latest model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>saved_model_dir = model.export(output_dir)
</pre></div>
</div>
</div>
</section>
<section id="9.-Post-training-quantization">
<h2>9. Post-training quantization<a class="headerlink" href="#9.-Post-training-quantization" title="Permalink to this heading">¶</a></h2>
<p>In this section, the <code class="docutils literal notranslate"><span class="pre">tlt</span></code> API uses <a class="reference external" href="https://github.com/intel/neural-compressor">Intel® Neural Compressor (INC)</a> to benchmark and quantize the model to get optimal inference performance. Note that this feature has only been implemented for use with custom image classification datasets. If you used a dataset from the TensorFlow dataset catalog, this will not work.</p>
<p>First, we create a config file to use with INC based on your model, dataset, and other quantization parameters. If you want more control over the configuration, you can provide your own custom yaml path for the <code class="docutils literal notranslate"><span class="pre">inc_config_file</span></code> instead of using the file generated by <code class="docutils literal notranslate"><span class="pre">write_inc_config_file()</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Create an output directory for quantization output with the same base name as our saved model directory
quantization_output_dir = os.path.join(output_dir, &#39;quantized_models&#39;, model.model_name,
                                       os.path.basename(saved_model_dir))

# Create a tuning workspace directory for INC
nc_workspace = os.path.join(output_dir, &#39;nc_workspace&#39;)

# Relative accuracy loss (1%)
relative_accuracy_criterion = 0.01

# Define the exit policy timeout (in seconds) and max number of trials. The tuning processing finishes when
# the timeout or max trials is reached. A tuning timeout of 0 means that the tuning phase stops when the
# accuracy criterion is met.
timeout = 0
max_trials=15

# Write an INC config file based on the dataset that we are using
inc_config_file = os.path.join(output_dir, &#39;inc_configs&#39;, model.model_name, os.path.basename(saved_model_dir),
                               &#39;{}.yaml&#39;.format(model.model_name))
model.write_inc_config_file(inc_config_file, dataset=dataset, batch_size=batch_size, overwrite=True,
                            accuracy_criterion_relative=relative_accuracy_criterion, exit_policy_timeout=timeout,
                            exit_policy_max_trials=max_trials, tuning_workspace=nc_workspace)

if os.path.exists(inc_config_file):
    print(&#39;INC config file has been written to: {}\n&#39;.format(inc_config_file))

    # Print configs for informational purposes
    with open(inc_config_file, &#39;r&#39;) as f:
        print(f.read())
</pre></div>
</div>
</div>
<p>We use the INC config to benchmark the full precision model to see how it performs, as our baseline.</p>
<blockquote>
<div><p>Note that there is a known issue when running INC from a notebook that you may sometimes see the error <code class="docutils literal notranslate"><span class="pre">zmq.error.ZMQError:</span> <span class="pre">Address</span> <span class="pre">already</span> <span class="pre">in</span> <span class="pre">use</span></code>. If you see this error, rerun the cell again.</p>
</div></blockquote>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model.benchmark(saved_model_dir, inc_config_file, &#39;performance&#39;)
</pre></div>
</div>
</div>
<p>Next we use INC to automatically search for the optimal quantization recipe for low-precision model inference within the accuracy loss constrains defined in the config. Running post training quantization may take several minutes, depending on your hardware and the exit policy (timeout and max trials).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model.quantize(saved_model_dir, quantization_output_dir, inc_config_file)
</pre></div>
</div>
</div>
<p>Let’s benchmark using the quantized model, so that we can compare the performance to the full precision model that was originally benchmarked.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>model.benchmark(quantization_output_dir, inc_config_file, &#39;performance&#39;)
</pre></div>
</div>
</div>
</section>
<section id="Dataset-Citations">
<h2>Dataset Citations<a class="headerlink" href="#Dataset-Citations" title="Permalink to this heading">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>@ONLINE {tfflowers,
author = &quot;The TensorFlow Team&quot;,
title = &quot;Flowers&quot;,
month = &quot;jan&quot;,
year = &quot;2019&quot;,
url = &quot;http://download.tensorflow.org/example_images/flower_photos.tgz&quot; }

@article{openimages,
  title={OpenImages: A public dataset for large-scale multi-label and multi-class image classification.},
  author={Krasin, Ivan and Duerig, Tom and Alldrin, Neil and Veit, Andreas and Abu-El-Haija, Sami
    and Belongie, Serge and Cai, David and Feng, Zheyun and Ferrari, Vittorio and Gomes, Victor
    and Gupta, Abhinav and Narayanan, Dhyanesh and Sun, Chen and Chechik, Gal and Murphy, Kevin},
  journal={Dataset available from https://github.com/openimages},
  year={2016}
}
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="TLT_PyTorch_Image_Classification_Transfer_Learning.html" class="btn btn-neutral float-left" title="Transfer Learning for Image Classification using PyTorch and the Intel® Transfer Learning Tool API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="TLT_TF_Text_Classification_Transfer_Learning.html" class="btn btn-neutral float-right" title="Text Classification fine tuning using TensorFlow and the Intel® Transfer Learning Tool API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Intel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>